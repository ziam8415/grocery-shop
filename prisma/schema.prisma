generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  //url      = env("DATABASE_URL")
}

/**
 * =======================
 * CATEGORY (SELF RELATION)
 * =======================
 */

model Category {
  id   String @id @default(uuid())
  name String
  slug String @unique

  parentId String?
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =======================
 * PRODUCT
 * =======================
 */

model Product {
  id   String @id @default(uuid())
  name String
  slug String @unique

  basePrice Float?
  salePrice Float?
  isActive  Boolean @default(true)

  description   String?
  ingredients   String?
  nutritionInfo Json?
  brand         String?
  expiryDays    Int?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  images     ProductImage[]
  variants   ProductVariant[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductImage {
  id     String  @id @default(uuid())
  url    String
  isMain Boolean @default(false)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
}

/**
 * =======================
 * PRODUCT VARIANTS
 * =======================
 */

model ProductVariant {
  id        String  @id @default(uuid())
  sku       String  @unique
  price     Float
  stock     Int?
  isDefault Boolean @default(false)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  attributes VariantAttribute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =======================
 * ATTRIBUTES
 * =======================
 */

model Attribute {
  id   String @id @default(uuid())
  name String @unique

  values AttributeValue[]
}

model AttributeValue {
  id    String @id @default(uuid())
  value String

  attributeId String
  attribute   Attribute @relation(fields: [attributeId], references: [id])

  variantAttributes VariantAttribute[]

  @@unique([attributeId, value])
}

model VariantAttribute {
  id String @id @default(uuid())

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  attributeValueId String
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id])

  @@unique([productVariantId, attributeValueId])
}

/**
 * =======================
 * USER & RBAC
 * =======================
 */

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  orders Order[]

  createdAt DateTime @default(now())
}

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  isSystem    Boolean @default(false)

  users       User[]
  permissions RolePermission[]
}

model Permission {
  id   String @id @default(uuid())
  name String @unique

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

/**
 * =======================
 * ORDERS
 * =======================
 */

model Order {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  status String @default("PENDING")
  total  Float

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  price    Float
  quantity Int

  createdAt DateTime @default(now())
}
